# 2023-01-14
## `MPI_Scatterv`, `MPI_Gattherv` and `MPI_Allgatherv`
The common thread between these three (and perhaps more) collective
communication functions are the two buffers `sendcounts` and `displs` (see `man 3 MPI_Gatherv` or [view online](https://www.open-mpi.org/doc/v3.1/man3/MPI_Gatherv.3.php)).

I found myself writing code to construct these two buffers every
time for roughly equal distribution. Here is the convenience function.

```C
#define check_mem(P) if ((P)==NULL) {                                                      \
    fprintf(stderr, "[ERROR] %s.%d in function %s: OOM\n", __FILE__, __LINE__, __func__);  \
    goto error;                                                                            \
}

typedef struct {
    int *sendcounts;
    int *displs;
} vparams_t;

int vparams_create(vparams_t *vp, int count, int nprocs) {
    int *sendcounts = malloc(sizeof(int) * nprocs);
    check_mem(sendcounts);
    int *displs = malloc(sizeof(int) * nprocs);
    check_mem(displs);
    // I hope the compiler generates a single div
    // instruction for these
    int quot = count / nprocs;
    int rem = count % nprocs;
    int running_displ = 0;
    for (int i = 0; i < nprocs; i++)
    {
        sendcounts[i] = quot;
        displs[i] = running_displ;
        running_displ += sendcounts[i];
    }

    // scatter the remaining uniformly between the first `rem` bins
    for (int i = 0; i < rem; i++)
    {
        sendcounts[i]++;
    }
    sp->sendcounts = sendcounts;
    sp->displs = displs;
    return 0;
error:
    return 1; 
}
```

## Presentation on Error Handling in C
Came across these nice [slides](https://resources.sei.cmu.edu/asset_files/Presentation/2016_017_101_484207.pdf).
